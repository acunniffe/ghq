const pgn1 = `
1. f2e3 skip {[%emt 418.4]}
2. c7d6 skip {[%emt 10.1]}
0-1 {[%sts resign]}
`;

const pgn2 = `
1. rhf1 rte1 rrd1 {[%emt 19]}
2. rhe8 rtd8 rpg8 {[%emt 12.5]}
3. e1e3↑ f2e1 f1f2↑ {[%emt 5.9]}
4. e8e7↓ d8d6↓ rff8 {[%emt 23.5]}
5. f2f3↑ g2f2 g1g2↑ {[%emt 8.2]}
6. e7e6↓ f8f7 rfe8 {[%emt 12.4]}
7. e1d2 e3e1↑ rpb1 {[%emt 18.2]}
8. e8c6 rfe8 rrd8 {[%emt 8.5]}
9. d1c2↑ rfd1 ric1 {[%emt 8.5]}
10. d6d5↓ d8d7↓ rrd8 {[%emt 10.4]}
11. c2c3↑ d1b3 rrd1 {[%emt 7.9]}
12. d5b5↓ d7d6↓ d8d7↓ {[%emt 18.9]}
13. b1a5xb5 b3b4 d1c2↖ {[%emt 17.1]}
14. d6d5↓ e6d6↙ d7e6↓ {[%emt 147.3]}
15. a5a4 b4b2 e1e3↑ {[%emt 40.9]}
16. d5d5↙ a7a6 b8a7↓ {[%emt 98.3]}
17. c3d3↑ b2d4xd5 a4b3 {[%emt 59.4]}
18. d6d6↓ a6b5 a7a6↓ {[%emt 72]}
19. b3b2 d4c3 d3e2↖ {[%emt 40]}
20. d6d5↘ a6b6↘ g8e1xe2 {[%emt 30.5]}
21. d2d1 f3e2↑ g2g1↑ {[%emt 49.2]}
22. d5c4↓ b6c5↘ f7f5 {[%emt 119.2]}
23. e3d2↑ c2d3↖ c3b3 {[%emt 77.3]}
24. sbc1 c4d5↓ c5c5↓ b5b6 {[%emt 65]}
25. d3c2↑ rff1xe1 d2e3↑ {[%emt 29.8]}
26. f5d3xe3 e8f7 c7d7 {[%emt 39.8]}
27. b2b1 f2f3 g1f2↖ {[%emt 16.9]}
28. d3b5 b6a5 rig8 {[%emt 26.6]}
29. f1h3 f3f4 h2g3 {[%emt 28.1]}
30. d5d6↘ c5d5↓ c6c5 {[%emt 41.3]}
31. b3c4 b1c6xd6 e2d2↑ {[%emt 76.8]}
32. d7c7 d5d6↓ b5b4xc4 {[%emt 141.1]}
33. f2e3↑ rfa1 rib1 {[%emt 23.5]}
34. sfc6 b4b5 a8b8 g8h7 {[%emt 29.5]}
35. b1b2 a1a3 rif1 {[%emt 19.8]}
36. b8c8 ria8 h7h6 {[%emt 20.4]}
37. rig1 f1f2 ria1 {[%emt 7.5]}
38. c8d8 b5b6 e6f6↓ {[%emt 37.4]}
39. e3f3↑ d2e3↑ f4e4 {[%emt 47.4]}
40. b6b5 f6g5↓ f7f6 {[%emt 19.6]}
41. g3f4 f3g2↑ c2d2↑ {[%emt 21.8]}
42. d6c6↘ c7d7 d8e8 {[%emt 66.3]}
43. e4e5 a3c3 g1f1 {[%emt 17.2]}
44. g5g6↓ c6c7↘ e8f8 {[%emt 10]}
45. h1g1 f4f5 e5e6xf6 {[%emt 12.3]}
46. d7e7 c5d6xe6 g6g7↓ {[%emt 11.5]}
47. d2e2↑ d1d2 f5f4 {[%emt 19]}
48. f8g8 e7f7 c7d7↓ {[%emt 7.4]}
49. e2f3↑ g2g3↑ f2e2 {[%emt 7.2]}
50. d7e7↓ f7f6 b7c8 {[%emt 5.8]}
51. e2d3 f1e2 g3g4↑ {[%emt 10.6]}
52. g7f7↓ skip {[%emt 13.1]}
53. f4g5 f3f4↑ e3e4↑ {[%emt 27.4]}
54. f6g7 e7d7↓ g8f8 {[%emt 6.2]}
55. g5g6 h3h5 g4g5↑ {[%emt 10.9]}
56. h6h7 g7g8 f8e8 {[%emt 7.6]}
57. h5h6 g6g7 g5g6↑ {[%emt 9.8]}
58. h7h8 g8f8 f7f7→ {[%emt 11.3]}
59. g7f6xf7 h6g7 d2e3 {[%emt 21.4]}
60. e8d8 d7c6↘ rie8 {[%emt 52.1]}
61. e4d4↑ f4e5↑ g6h7↑ {[%emt 47.7]}
62. c6c7↘ d6c6 h8g8 {[%emt 20.2]}
63. h7h8← e5e4↑ e2f3 {[%emt 14.8]}
64. f8f7 e8e7 c7b6↘ {[%emt 14.2]}
65. sbg8 sff7 d4c4↑ b2b3 a1a2 {[%emt 28.1]}
66. c8d7 d8c8 c6d6 {[%emt 11.5]}
67. e4d5↑ e3e4 f3f4 {[%emt 31.4]}
68. d6e5 e7f7 d7e6 {[%emt 7.9]}
69. f4f5xe5 e4e5xe6 a2a3 {[%emt 12.3]}
70. b5b4 a5a4 b6a6↘ {[%emt 8.3]}
71. sff7 c4d4← d5e4↖ f5e6 {[%emt 15.1]}
72. c8b8 a8b7 b4b5 {[%emt 15.3]}
73. sba4 c3a5 b3b4xb5 d4d4↖ {[%emt 14.8]}
74. b7c8 a6b7↓ b8a8 {[%emt 7.7]}
75. a5a7xb7 e6d6 g7e7 {[%emt 9.6]}
76. skip {[%emt 6.8]}
77. d4d5↖ e7c7 d6d7 {[%emt 27.9]}
78. a8b8 rie8 rid8 {[%emt 11.6]}
79. a7a8 c7b7xb8 skip {[%emt 10.1]}
1-0 {[%sts timeout]}
`;

const pgn3 = `
1. rhf1 rte1 rrd1 {[%emt 19]}
2. rhe8 rtd8 rpg8 {[%emt 12.5]}
3. e1e3↑ f2e1 f1f2↑ {[%emt 5.9]}
4. e8e7↓ d8d6↓ rff8 {[%emt 23.5]}
5. f2f3↑ g2f2 g1g2↑ {[%emt 8.2]}
6. e7e6↓ f8f7 rfe8 {[%emt 12.4]}
7. e1d2 e3e1↑ rpb1 {[%emt 18.2]}
8. e8c6 rfe8 rrd8 {[%emt 8.5]}
9. d1c2↑ rfd1 ric1 {[%emt 8.5]}
10. d6d5↓ d8d7↓ rrd8 {[%emt 10.4]}
11. c2c3↑ d1b3 rrd1 {[%emt 7.9]}
12. d5b5↓ d7d6↓ d8d7↓ {[%emt 18.9]}
13. b1a5xb5 b3b4 d1c2↖ {[%emt 17.1]}
14. d6d5↓ e6d6↙ d7e6↓ {[%emt 147.3]}
15. a5a4 b4b2 e1e3↑ {[%emt 40.9]}
16. d5d5↙ a7a6 b8a7↓ {[%emt 98.3]}
17. c3d3↑ b2d4xd5 a4b3 {[%emt 59.4]}
18. d6d6↓ a6b5 a7a6↓ {[%emt 72]}
19. b3b2 d4c3 d3e2↖ {[%emt 40]}
20. d6d5↘ a6b6↘ g8e1xe2 {[%emt 30.5]}
21. d2d1 f3e2↑ g2g1↑ {[%emt 49.2]}
22. d5c4↓ b6c5↘ f7f5 {[%emt 119.2]}
23. e3d2↑ c2d3↖ c3b3 {[%emt 77.3]}
24. sbc1 c4d5↓ c5c5↓ b5b6 {[%emt 65]}
25. d3c2↑ rff1xe1 d2e3↑ {[%emt 29.8]}
26. f5d3xe3 e8f7 c7d7 {[%emt 39.8]}
27. b2b1 f2f3 g1f2↖ {[%emt 16.9]}
28. d3b5 b6a5 rig8 {[%emt 26.6]}
29. f1h3 f3f4 h2g3 {[%emt 28.1]}
30. d5d6↘ c5d5↓ c6c5 {[%emt 41.3]}
31. b3c4 b1c6xd6 e2d2↑ {[%emt 76.8]}
32. d7c7 d5d6↓ b5b4xc4 {[%emt 141.1]}
33. f2e3↑ rfa1 rib1 {[%emt 23.5]}
34. sfc6 b4b5 a8b8 g8h7 {[%emt 29.5]}
35. b1b2 a1a3 rif1 {[%emt 19.8]}
36. b8c8 ria8 h7h6 {[%emt 20.4]}
37. rig1 f1f2 ria1 {[%emt 7.5]}
38. c8d8 b5b6 e6f6↓ {[%emt 37.4]}
39. e3f3↑ d2e3↑ f4e4 {[%emt 47.4]}
40. b6b5 f6g5↓ f7f6 {[%emt 19.6]}
41. g3f4 f3g2↑ c2d2↑ {[%emt 21.8]}
42. d6c6↘ c7d7 d8e8 {[%emt 66.3]}
43. e4e5 a3c3 g1f1 {[%emt 17.2]}
44. g5g6↓ c6c7↘ e8f8 {[%emt 10]}
45. h1g1 f4f5 e5e6xf6 {[%emt 12.3]}
46. d7e7 c5d6xe6 g6g7↓ {[%emt 11.5]}
47. d2e2↑ d1d2 f5f4 {[%emt 19]}
48. f8g8 e7f7 c7d7↓ {[%emt 7.4]}
49. e2f3↑ g2g3↑ f2e2 {[%emt 7.2]}
50. d7e7↓ f7f6 b7c8 {[%emt 5.8]}
51. e2d3 f1e2 g3g4↑ {[%emt 10.6]}
52. g7f7↓ skip {[%emt 13.1]}
53. f4g5 f3f4↑ e3e4↑ {[%emt 27.4]}
54. f6g7 e7d7↓ g8f8 {[%emt 6.2]}
55. g5g6 h3h5 g4g5↑ {[%emt 10.9]}
56. h6h7 g7g8 f8e8 {[%emt 7.6]}
57. h5h6 g6g7 g5g6↑ {[%emt 9.8]}
58. h7h8 g8f8 f7f7→ {[%emt 11.3]}
59. g7f6xf7 h6g7 d2e3 {[%emt 21.4]}
60. e8d8 d7c6↘ rie8 {[%emt 52.1]}
61. e4d4↑ f4e5↑ g6h7↑ {[%emt 47.7]}
62. c6c7↘ d6c6 h8g8 {[%emt 20.2]}
63. h7h8← e5e4↑ e2f3 {[%emt 14.8]}
64. f8f7 e8e7 c7b6↘ {[%emt 14.2]}
65. sbg8 sff7 d4c4↑ b2b3 a1a2 {[%emt 28.1]}
66. c8d7 d8c8 c6d6 {[%emt 11.5]}
67. e4d5↑ e3e4 f3f4 {[%emt 31.4]}
68. d6e5 e7f7 d7e6 {[%emt 7.9]}
69. f4f5xe5 e4e5xe6 a2a3 {[%emt 12.3]}
70. b5b4 a5a4 b6a6↘ {[%emt 8.3]}
71. sff7 c4d4← d5e4↖ f5e6 {[%emt 15.1]}
72. c8b8 a8b7 b4b5 {[%emt 15.3]}
73. sba4 c3a5 b3b4xb5 d4d4↖ {[%emt 14.8]}
74. b7c8 a6b7↓ b8a8 {[%emt 7.7]}
75. a5a7xb7 e6d6 g7e7 {[%emt 9.6]}
76. skip {[%emt 6.8]}
77. d4d5↖ e7c7 d6d7 {[%emt 27.9]}
78. a8b8 rie8 rid8 {[%emt 11.6]}
79. a7a8 c7b7xb8 skip {[%emt 10.1]}
0-1 {[%sts hq-capture]}
`;

const pgn4 = `
1. rhc1 rtd1 rre1 {[%emt 12.9]}
2. rhd8 rte8 rpg8 {[%emt 5.1]}
3. e1e2↑ d1d3↑ rrd1 {[%emt 11.2]}
4. d8d7↓ e8e6↓ rrf8 {[%emt 7.8]}
5. rpa1 rfb1 c1c2↑ {[%emt 8.3]}
6. d7d6↓ rrd8 rfe8 {[%emt 10.3]}
7. e2e3↑ c2c3↑ d1c2↑ {[%emt 14.8]}
8. sbd3 c7b6 b8c7↓ d8e7↓ {[%emt 12.7]}
9. a1d7xd6 c3c4↑ c2d3↑ {[%emt 16.8]}
10. e8d8 g8d6xd7 c7c8↓ {[%emt 27.9]}
11. d3d4↑ b1b3 g1f1↑ {[%emt 17.7]}
12. d6d7 e6f6↙ e7e6↙ {[%emt 12.7]}
13. e3f4↑ d4e4↑ c4d3↑ {[%emt 12.1]}
14. e6e7↓ f6f7↓ d7e8 {[%emt 5]}
15. e4d5↑ d3e4↑ b3d3 {[%emt 9.9]}
16. e8c5xd5 e7d6↓ f8g7↓ {[%emt 11.1]}
17. skip {[%emt 0.2]}
18. skip {[%emt 11.9]}
1/2-1/2 {[%sts double-skip]}
`;

import { describe, it, expect } from "@jest/globals";
import { pgnToTurns, createPGN } from "./pgn";

describe("pgnToTurns", () => {
  it("parses simple PGN with resignation", () => {
    const turns = pgnToTurns(pgn1);

    expect(turns).toHaveLength(3);

    expect(turns[0].turn).toBe(1);
    expect(turns[0].moves).toHaveLength(2);
    expect(turns[0].elapsedSecs).toBe(418.4);

    expect(turns[1].turn).toBe(2);
    expect(turns[1].moves).toHaveLength(2);
    expect(turns[1].elapsedSecs).toBe(10.1);

    expect(turns[2].turn).toBe(3);
    expect(turns[2].moves).toHaveLength(0);
    expect(turns[2].winner).toBe("1");
  });

  it("parses complex multi-move PGN", () => {
    const turns = pgnToTurns(pgn2);

    expect(turns.length).toBeGreaterThan(0);

    expect(turns[0].turn).toBe(1);
    expect(turns[0].moves).toHaveLength(3);
    expect(turns[0].elapsedSecs).toBe(19);

    expect(turns[1].turn).toBe(2);
    expect(turns[1].moves).toHaveLength(3);
    expect(turns[1].elapsedSecs).toBe(12.5);
  });

  it("parses elapsed time correctly", () => {
    const turns = pgnToTurns(pgn4);

    expect(turns[0].elapsedSecs).toBe(12.9);
    expect(turns[1].elapsedSecs).toBe(5.1);
    expect(turns[2].elapsedSecs).toBe(11.2);
    expect(turns[3].elapsedSecs).toBe(7.8);
  });

  it("handles skip moves", () => {
    const turns = pgnToTurns(pgn1);

    expect(turns[0].moves).toHaveLength(2);
    expect(turns[1].moves).toHaveLength(2);

    const hasSkipMove = turns.some((turn) =>
      turn.moves.some((move) => move.name === "Skip")
    );
    expect(hasSkipMove).toBe(true);
  });

  it("parses turn numbers sequentially", () => {
    const turns = pgnToTurns(pgn2);

    turns.forEach((turn, index) => {
      expect(turn.turn).toBe(index + 1);
    });
  });

  it("handles empty PGN string", () => {
    const turns = pgnToTurns("");
    expect(turns).toHaveLength(0);
  });

  it("handles PGN with only whitespace", () => {
    const turns = pgnToTurns("   \n  \n  ");
    expect(turns).toHaveLength(0);
  });

  it("parses four-move turns correctly", () => {
    const turns = pgnToTurns(pgn2);

    const fourMoveTurn = turns.find((turn) => turn.moves.length === 4);
    expect(fourMoveTurn).toBeDefined();
    expect(fourMoveTurn!.moves).toHaveLength(4);
  });

  it("parses resignation outcomes", () => {
    const turns1 = pgnToTurns(pgn1);
    const resignTurn1 = turns1.find((turn) => turn.status === "resign");
    expect(resignTurn1).toBeDefined();
    expect(resignTurn1?.winner).toBe("1");
    expect(resignTurn1?.moves).toHaveLength(0);
  });

  it("parses timeout status correctly", () => {
    const turns = pgnToTurns(pgn2);
    const lastTurn = turns[turns.length - 1];

    expect(lastTurn.status).toBe("timeout");
    expect(lastTurn.winner).toBe("0");
    expect(lastTurn.moves).toHaveLength(0);
  });

  it("parses hq-capture status correctly", () => {
    const turns = pgnToTurns(pgn3);
    const lastTurn = turns[turns.length - 1];

    expect(lastTurn.status).toBe("hq-capture");
    expect(lastTurn.winner).toBe("1");
    expect(lastTurn.moves).toHaveLength(0);
  });

  it("parses double-skip status correctly (draw)", () => {
    const turns = pgnToTurns(pgn4);
    const lastTurn = turns[turns.length - 1];

    expect(lastTurn.status).toBe("double-skip");
    expect(lastTurn.winner).toBeUndefined();
    expect(lastTurn.moves).toHaveLength(0);
  });

  it("parses resign status with winner field", () => {
    const turns = pgnToTurns(pgn1);
    const resignTurn = turns[turns.length - 1];

    expect(resignTurn.status).toBe("resign");
    expect(resignTurn.winner).toBe("1");
  });

  it("round-trips PGN correctly for all outcomes", () => {
    const testCases = [
      { pgn: pgn1, expectedStatus: "resign" },
      { pgn: pgn2, expectedStatus: "timeout" },
      { pgn: pgn3, expectedStatus: "hq-capture" },
      { pgn: pgn4, expectedStatus: "double-skip" },
    ];

    testCases.forEach(({ pgn, expectedStatus }) => {
      const turns = pgnToTurns(pgn);
      const lastTurn = turns[turns.length - 1];
      expect(lastTurn.status).toBe(expectedStatus);

      const recreatedPgn = createPGN(turns);
      const reparsedTurns = pgnToTurns(recreatedPgn);

      expect(reparsedTurns).toHaveLength(turns.length);
      expect(reparsedTurns[reparsedTurns.length - 1].status).toBe(
        expectedStatus
      );
    });
  });
});
